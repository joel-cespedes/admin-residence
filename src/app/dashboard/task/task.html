<movsa-header title="Tasks" />

<div class="filter-section">
  <div class="residence-selector">
    <div class="selector-header">
      <div class="selector-header-title">Filtrar por Residencia</div>
      @if (isLoadingResidences()) {
        <mat-spinner diameter="20"></mat-spinner>
      }
    </div>

    <div class="select-container">
      <mat-form-field class="style_select">
        <mat-label>Residencia</mat-label>
        <mat-select
          [value]="selectedResidence()"
          (selectionChange)="onResidenceChange($event.value)"
          placeholder="Todas las residencias">
          <mat-option value="">Todas las residencias</mat-option>
          @for (residence of residences(); track residence.id) {
            <mat-option [value]="residence.id">
              {{ residence.name }}
            </mat-option>
          }
          @if (residences().length === 0) {
            <mat-option disabled>No hay residencias disponibles</mat-option>
          }
        </mat-select>
      </mat-form-field>
    </div>
  </div>

  <!-- Categories Section - Only visible when residence is selected -->
  @if (selectedResidence()) {
    <div class="categories-section">
      <div class="selector-header">
        <h3>Filtrar por Categoría</h3>
        @if (isLoadingCategories()) {
          <mat-spinner diameter="20"></mat-spinner>
        }
      </div>

      @if (categories().length === 0 && !isLoadingCategories()) {
        <div class="no-categories">
          <p>No hay categorías disponibles en esta residencia.</p>
        </div>
      } @else {
        <mat-button-toggle-group [value]="selectedCategory()" (change)="onCategoryChange($event.value)" class="category-toggles">
          @for (category of categories(); track category.id) {
            <mat-button-toggle [value]="category.id">
              {{ category.name }}
            </mat-button-toggle>
          }
        </mat-button-toggle-group>
      }
    </div>
  }
</div>

<div class="tasks-section">
  <div class="table-header">
    <div class="add-table-button">
      <button class="btn_style btn_rounded" matTooltip="Agregar task" (click)="openCreateModal()">
        <span class="mat-icon">add</span>
      </button>
    </div>

    <div class="filter-field">
      <input matInput type="search" [value]="searchTerm()" (keyup)="onSearch($event)" placeholder="Buscar task..." />
    </div>
  </div>

  <div class="table-container">
    @if (isLoadingData()) {
      <div class="loading-container">
        <mat-spinner diameter="40"></mat-spinner>
        <p>Cargando tasks...</p>
      </div>
    }

    <div class="table-wrapper">
      <table
        mat-table
        [dataSource]="dataSource"
        matSort
        [matSortActive]="pagination().sortBy"
        [matSortDirection]="pagination().sortOrder"
        matSortDisableClear>
        <ng-container matColumnDef="name">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>Nombre</th>
          <td mat-cell *matCellDef="let task">{{ task.name }}</td>
        </ng-container>

        <ng-container matColumnDef="category_name">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>Categoría</th>
          <td mat-cell *matCellDef="let task">{{ task.category_name }}</td>
        </ng-container>

        <ng-container matColumnDef="residence_name">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>Residencia</th>
          <td mat-cell *matCellDef="let task">{{ task.residence_name }}</td>
        </ng-container>

        <ng-container matColumnDef="created_by_info">
          <th mat-header-cell *matHeaderCellDef>Creado por</th>
          <td mat-cell *matCellDef="let task">
            <div class="created-by-info">
              <div class="created-by-name">{{ task.created_by_info?.name || 'Unknown' }}</div>
              <div class="created-by-alias">@{{ task.created_by_info?.alias || '' }}</div>
            </div>
          </td>
        </ng-container>

        <ng-container matColumnDef="created_at">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>Fecha de Creación</th>
          <td mat-cell *matCellDef="let task">{{ task.created_at | date: 'dd/MM/yyyy' }}</td>
        </ng-container>

        <ng-container matColumnDef="actions">
          <th mat-header-cell *matHeaderCellDef>Acciones</th>
          <td mat-cell *matCellDef="let task">
            <div class="action-buttons">
              <button class="btn_color btn_lightblue btn_small" matTooltip="Ver" (click)="openViewModal(task)">
                <span class="mat-icon">visibility</span>
              </button>

              <button class="btn_color btn_darkblue btn_small" matTooltip="Editar" (click)="openEditModal(task)">
                <span class="mat-icon">edit</span>
              </button>

              <button class="btn_color btn_red btn_small" matTooltip="Eliminar" (click)="openDeleteModal(task)">
                <span class="mat-icon">delete</span>
              </button>
            </div>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>

        @if (!isLoadingData() && dataSource.data.length === 0) {
          <tr class="mat-row">
            <td class="mat-cell" [attr.colspan]="displayedColumns.length">
              @if (searchTerm().trim()) {
                No se encontraron tasks que coincidan con "{{ searchTerm().trim() }}"
              } @else {
                No hay tasks registrados todavía
              }
            </td>
          </tr>
        }
      </table>

    </div>
      <mat-paginator
        [length]="totalItems()"
        [pageIndex]="pagination().pageIndex"
        [pageSize]="pagination().pageSize"
        [pageSizeOptions]="[10, 20, 50, 100]"
        aria-label="Seleccionar página de tasks"
        (page)="onPageChange($event)"></mat-paginator>
    </div>
</div>