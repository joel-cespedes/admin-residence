<div class="title_modal">{{ isEditMode() ? 'Editar Task' : 'Crear Nuevo Task' }}</div>
<div mat-dialog-content>
  @if (isLoading()) {
    <div class="loading-container">
      <mat-spinner diameter="40"></mat-spinner>
      <p>Cargando...</p>
    </div>
  } @else {
    <form [formGroup]="form">
      <mat-form-field appearance="outline" class="full-width custom-field">
        <mat-label>Nombre</mat-label>
        <input matInput formControlName="name" placeholder="Nombre del task" />
        @if (form.get('name')?.hasError('required')) {
          <mat-error>El nombre es obligatorio</mat-error>
        }
        @if (form.get('name')?.hasError('minlength')) {
          <mat-error>El nombre debe tener al menos 2 caracteres</mat-error>
        }
        @if (form.get('name')?.hasError('maxlength')) {
          <mat-error>El nombre no puede superar los 100 caracteres</mat-error>
        }
      </mat-form-field>

      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Residencia</mat-label>
        <mat-select
          formControlName="residence_id"
          (selectionChange)="onResidenceChange($event.value)"
          placeholder="Selecciona una residencia"
          [disabled]="isEditMode()"
          [attr.aria-disabled]="isEditMode() ? 'true' : null">
          @for (residence of data.residences; track residence.id) {
            <mat-option [value]="residence.id">
              {{ residence.name }}
            </mat-option>
          }
          @if (data.residences.length === 0) {
            <mat-option disabled>No hay residencias disponibles</mat-option>
          }
        </mat-select>
        @if (form.get('residence_id')?.hasError('required')) {
          <mat-error>Debe seleccionar una residencia</mat-error>
        }
      </mat-form-field>

      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Categoría</mat-label>
        <mat-select
          formControlName="task_category_id"
          placeholder="Selecciona una categoría"
          [disabled]="!form.get('residence_id')?.value || isLoadingCategories()">
          @if (isLoadingCategories()) {
            <mat-option disabled>
              <div class="loading-option">
                <mat-spinner diameter="16"></mat-spinner>
                <span>Cargando categorías...</span>
              </div>
            </mat-option>
          } @else if (categories().length === 0) {
            <mat-option disabled>
              @if (form.get('residence_id')?.value) {
                No hay categorías disponibles en esta residencia
              } @else {
                Selecciona una residencia primero
              }
            </mat-option>
          } @else {
            @for (category of categories(); track category.id) {
              <mat-option [value]="category.id">
                {{ category.name }}
              </mat-option>
            }
          }
        </mat-select>
        @if (form.get('task_category_id')?.hasError('required')) {
          <mat-error>Debe seleccionar una categoría</mat-error>
        }
      </mat-form-field>

      <div class="colum-two">
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Status 1</mat-label>
          <input matInput formControlName="status1" placeholder="Texto para status 1" />
        </mat-form-field>

        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Status 2</mat-label>
          <input matInput formControlName="status2" placeholder="Texto para status 2" />
        </mat-form-field>
      </div>
      <div class="colum-two">
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Status 3</mat-label>
          <input matInput formControlName="status3" placeholder="Texto para status 3" />
        </mat-form-field>

        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Status 4</mat-label>
          <input matInput formControlName="status4" placeholder="Texto para status 4" />
        </mat-form-field>
      </div>
      <div class="colum-two">
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Status 5</mat-label>
          <input matInput formControlName="status5" placeholder="Texto para status 5" />
        </mat-form-field>

        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Status 6</mat-label>
          <input matInput formControlName="status6" placeholder="Texto para status 6" />
        </mat-form-field>
      </div>

      <div class="checkbox-field">
        <mat-checkbox formControlName="is_block">Bloquear Task</mat-checkbox>
      </div>
    </form>
  }
</div>

<div mat-dialog-actions align="end">
  <button mat-button (click)="onCancel()" [disabled]="isLoading()">Cancelar</button>
  <button mat-raised-button color="primary" (click)="onSubmit()" [disabled]="form.invalid || isLoading()">
    @if (!isLoading()) {
      <span>{{ isEditMode() ? 'Actualizar' : 'Crear' }}</span>
    }
    @if (isLoading()) {
      <span>Guardando...</span>
    }
  </button>
</div>
