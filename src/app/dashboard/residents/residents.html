<movsa-header title="Residentes" />

<!-- Filter Section -->
<div class="filter-section">
  <div class="grid_selects">
    <!-- Residence Section - Always visible -->
    <div class="residence-section">
      <div class="selector-header">
        <div class="selector-header-title">Filtrar por Residencia</div>
        @if (isLoadingResidences()) {
          <mat-spinner diameter="20"></mat-spinner>
        }
      </div>

      <div class="select-container">
        <mat-form-field class="style_select">
          <mat-label>Residencia</mat-label>
          <mat-select [value]="filters().residence_id" (selectionChange)="onResidenceChange($event.value)">
            @for (residence of residences(); track residence.id) {
              <mat-option [value]="residence.id">
                {{ residence.name }}
              </mat-option>
            }
            @if (residences().length === 0 && !isLoadingResidences()) {
              <mat-option disabled>No hay residencias disponibles</mat-option>
            }
          </mat-select>
        </mat-form-field>
      </div>
    </div>

    <!-- Floors Section - Always visible but disabled when no residence selected -->
    <div class="floors-section">
      <div class="selector-header">
        <div class="selector-header-title">Filtrar por Piso</div>
        @if (isLoadingFloors()) {
          <mat-spinner diameter="20"></mat-spinner>
        }
      </div>

      <div class="select-container">
        <mat-form-field class="style_select">
          <mat-label>Piso</mat-label>
          <mat-select
            [value]="filters().floor_id"
            (selectionChange)="onFloorChange($event.value)"
            [disabled]="!filters().residence_id">
            @for (floor of floors(); track floor.id) {
              <mat-option [value]="floor.id">
                {{ floor.name }}
              </mat-option>
            }
            @if (floors().length === 0 && !isLoadingFloors()) {
              <mat-option disabled>No hay pisos disponibles</mat-option>
            }
          </mat-select>
        </mat-form-field>
      </div>
    </div>

    <!-- Rooms Section - Always visible but disabled when no floor selected -->
    <div class="rooms-section">
      <div class="selector-header">
        <div class="selector-header-title">Filtrar por Habitación</div>
        @if (isLoadingRooms()) {
          <mat-spinner diameter="20"></mat-spinner>
        }
      </div>

      <div class="select-container">
        <mat-form-field class="style_select">
          <mat-label>Habitación</mat-label>
          <mat-select [value]="filters().room_id" (selectionChange)="onRoomChange($event.value)" [disabled]="!filters().floor_id">
            @for (room of rooms(); track room.id) {
              <mat-option [value]="room.id">
                {{ room.name }}
              </mat-option>
            }
            @if (rooms().length === 0 && !isLoadingRooms()) {
              <mat-option disabled>No hay habitaciones disponibles</mat-option>
            }
          </mat-select>
        </mat-form-field>
      </div>
    </div>
  </div>

  <!-- Beds Section - Only visible when room is selected -->
  @if (filters().room_id) {
    <div class="beds-section">
      <div class="selector-header">
        <div class="selector-header-title">Filtrar por Cama</div>
        @if (isLoadingBeds()) {
          <mat-spinner diameter="20"></mat-spinner>
        }
      </div>

      @if (beds().length === 0 && !isLoadingBeds()) {
        <div class="no-beds">
          <p>No hay camas disponibles en esta habitación.</p>
        </div>
      } @else {
        <mat-button-toggle-group [value]="filters().bed_id" (change)="onBedChange($event.value)" class="bed-toggles">
          @for (bed of beds(); track bed.id) {
            <mat-button-toggle [value]="bed.id">
              {{ bed.name }}
            </mat-button-toggle>
          }
        </mat-button-toggle-group>
      }
    </div>
  }
</div>

<!-- Residents Table - Always visible -->
<div class="residents-section">
  <div class="table-header">
    @if (canCreate()) {
      <div class="add-table-button">
        <button class="btn_style btn_rounded" matTooltip="Agregar residente" (click)="addResident()">
          <span class="mat-icon">add</span>
        </button>
      </div>
    }
    <div class="filter-field">
      <input matInput (keyup)="applyFilter($event)" placeholder="Buscar residente..." #input />
    </div>
  </div>

  <div class="table-container">
    @if (isLoadingData()) {
      <div class="loading-container">
        <mat-spinner diameter="40"></mat-spinner>
        <p>Cargando residentes...</p>
      </div>
    }

    <div class="mat-elevation-z8">
      <table mat-table [dataSource]="dataSource" matSort>
        <!-- Full Name Column -->
        <ng-container matColumnDef="full_name">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>Nombre Completo</th>
          <td mat-cell *matCellDef="let resident">{{ resident.full_name }}</td>
        </ng-container>

        <!-- Birth Date Column -->
        <ng-container matColumnDef="birth_date">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>Fecha de Nacimiento</th>
          <td mat-cell *matCellDef="let resident">{{ resident.birth_date | dateFormat }}</td>
        </ng-container>

        <!-- Status Column -->
        <ng-container matColumnDef="status">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>Estado</th>
          <td mat-cell *matCellDef="let resident">
            @if (resident.status === 'active') {
              <span class="status-active">Activo</span>
            } @else if (resident.status === 'discharged') {
              <span class="status-discharged">Dado de alta</span>
            } @else if (resident.status === 'deceased') {
              <span class="status-deceased">Fallecido</span>
            }
          </td>
        </ng-container>

        <!-- Bed Name Column -->
        <ng-container matColumnDef="bed_name">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>Cama</th>
          <td mat-cell *matCellDef="let resident">{{ resident.bed_name || 'Sin asignar' }}</td>
        </ng-container>

        <!-- Room Name Column -->
        <ng-container matColumnDef="room_name">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>Habitación</th>
          <td mat-cell *matCellDef="let resident">{{ resident.room_name || 'Sin asignar' }}</td>
        </ng-container>

        <!-- Floor Name Column -->
        <ng-container matColumnDef="floor_name">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>Piso</th>
          <td mat-cell *matCellDef="let resident">{{ resident.floor_name || 'Sin asignar' }}</td>
        </ng-container>

        <!-- Residence Name Column -->
        <ng-container matColumnDef="residence_name">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>Residencia</th>
          <td mat-cell *matCellDef="let resident">{{ resident.residence_name || 'Sin asignar' }}</td>
        </ng-container>

        <!-- Created At Column -->
        <ng-container matColumnDef="created_at">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>Fecha de Creación</th>
          <td mat-cell *matCellDef="let resident">{{ resident.created_at | dateFormat: 'full' }}</td>
        </ng-container>

        <!-- Actions Column -->
        <ng-container matColumnDef="actions">
          <th mat-header-cell *matHeaderCellDef>Acciones</th>
          <td mat-cell *matCellDef="let resident">
            <div class="action-buttons">
              <button class="btn_color btn_lightblue btn_small" color="primary" (click)="viewResident(resident)" matTooltip="Ver">
                <span class="mat-icon">visibility</span>
              </button>

              @if (canEdit()) {
                <button
                  class="btn_color btn_darkblue btn_small"
                  color="accent"
                  (click)="editResident(resident)"
                  matTooltip="Editar">
                  <span class="mat-icon">edit</span>
                </button>
              }

              @if (canDelete()) {
                <button class="btn_color btn_red btn_small" color="warn" (click)="deleteResident(resident)" matTooltip="Eliminar">
                  <span class="mat-icon">delete</span>
                </button>
              }
            </div>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>

        <!-- Row shown when there is no matching data. -->
        @if (dataSource.data.length === 0) {
          <tr class="mat-row">
            <td class="mat-cell" [attr.colspan]="displayedColumns.length">
              @if (filters().search) {
                No se encontraron residentes que coincidan con "{{ input.value }}"
              } @else {
                No se encontraron residentes
              }
            </td>
          </tr>
        }
      </table>

      <mat-paginator
        [length]="pagination().total"
        [pageIndex]="pagination().page"
        [pageSize]="pagination().size"
        [pageSizeOptions]="[15, 25, 50, 100]"
        aria-label="Seleccionar pógina de residentes"></mat-paginator>
    </div>
  </div>
</div>
