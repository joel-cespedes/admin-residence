<movsa-header title="Gestores" />

<div class="residence-selector">
  <div class="selector-header">
    <div class="selector-header-title">Filtrar por Residencia</div>
    @if (isLoadingResidences()) {
      <mat-spinner diameter="20"></mat-spinner>
    }
  </div>

  @if (!isLoadingResidences() && residences().length === 0) {
    <div class="no-residences">
      <p>No hay residencias disponibles. Primero crea una residencia.</p>
    </div>
  } @else {
    <mat-button-toggle-group
      class="residence-toggles"
      [disabled]="isLoadingResidences()"
      [value]="filters().residence_id"
      (change)="onResidenceChange($event.value)">
      <mat-button-toggle value="">Todas</mat-button-toggle>
      @for (residence of residences(); track residence.id) {
        <mat-button-toggle [value]="residence.id">{{ residence.name }}</mat-button-toggle>
      }
    </mat-button-toggle-group>
  }
</div>

<div class="managers-section">
  <div class="table-header">
    <div class="add-table-button">
      <button class="btn_style btn_rounded" matTooltip="Agregar gestor" (click)="addManager()">
        <span class="mat-icon">add</span>
      </button>
    </div>
    <div class="filter-field">
      <input matInput (keyup)="applyFilter($event)" placeholder="Buscar gestor..." #input />
    </div>
  </div>

  <div class="table-container">
    @if (isLoadingData()) {
      <div class="loading-container">
        <mat-spinner diameter="40"></mat-spinner>
        <p>Cargando gestores...</p>
      </div>
    } @else if (dataSource.data.length === 0) {
      <div class="no-data-container">
        <span class="mat-icon">people</span>
        <p>No se encontraron gestores</p>
        <button class="btn_style btn_rounded" matTooltip="Agregar primer gestor" (click)="addManager()">
          <span class="mat-icon">add</span>
        </button>
      </div>
    } @else {
      <table mat-table [dataSource]="dataSource" matSort>
        <!-- Username Column -->
        <ng-container matColumnDef="username">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>Usuario</th>
          <td mat-cell *matCellDef="let manager">{{ manager.username }}</td>
        </ng-container>

        <!-- Full Name Column -->
        <ng-container matColumnDef="full_name">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>Nombre Completo</th>
          <td mat-cell *matCellDef="let manager">{{ manager.full_name }}</td>
        </ng-container>

        <!-- Email Column -->
        <ng-container matColumnDef="email">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>Email</th>
          <td mat-cell *matCellDef="let manager">{{ manager.email }}</td>
        </ng-container>

        <!-- Status Column -->
        <ng-container matColumnDef="status">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>Estado</th>
          <td mat-cell *matCellDef="let manager">
            @if (manager.status === 'active') {
              <span class="status-active">Activo</span>
            } @else if (manager.status === 'inactive') {
              <span class="status-inactive">Inactivo</span>
            } @else if (manager.status === 'suspended') {
              <span class="status-suspended">Suspendido</span>
            }
          </td>
        </ng-container>

        <!-- Residence Names Column -->
        <ng-container matColumnDef="residence_names">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>Residencias</th>
          <td mat-cell *matCellDef="let manager">
            @if (manager.residence_names && manager.residence_names.length > 0) {
              <div class="residence-badges">
                @for (residence of manager.residence_names; track $index) {
                  <span class="residence-badge">{{ residence }}</span>
                }
              </div>
            } @else {
              <span class="no-residences">Sin asignar</span>
            }
          </td>
        </ng-container>

        <!-- Created By Column (solo para superadmin) -->
        <ng-container matColumnDef="created_by_name">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>Creado por</th>
          <td mat-cell *matCellDef="let manager">
            {{ manager.created_by_name || 'Sistema' }}
          </td>
        </ng-container>

        <!-- Created At Column -->
        <ng-container matColumnDef="created_at">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>Fecha de Creaci√≥n</th>
          <td mat-cell *matCellDef="let manager">{{ manager.created_at | dateFormat: 'full' }}</td>
        </ng-container>

        <!-- Actions Column -->
        <ng-container matColumnDef="actions">
          <th mat-header-cell *matHeaderCellDef>Acciones</th>
          <td mat-cell *matCellDef="let manager">
            <div class="action-buttons">
              <button class="icon-btn view-btn" matTooltip="Ver detalles" (click)="viewManager(manager)">
                <span class="mat-icon">visibility</span>
              </button>
              <button class="icon-btn edit-btn" matTooltip="Editar gestor" (click)="editManager(manager)">
                <span class="mat-icon">edit</span>
              </button>
              <button class="icon-btn delete-btn" matTooltip="Eliminar gestor" (click)="deleteManager(manager)">
                <span class="mat-icon">delete</span>
              </button>
            </div>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="getDisplayedColumns()"></tr>
        <tr mat-row *matRowDef="let row; columns: getDisplayedColumns();"></tr>
      </table>

      <mat-paginator
        [length]="pagination().total"
        [pageSize]="pagination().size"
        [pageIndex]="pagination().page - 1"
        [pageSizeOptions]="[5, 10, 25, 50]"
        (page)="onPageChange($event)"
        showFirstLastButtons>
      </mat-paginator>
    }
  </div>
</div>
