<div class="title_modal">{{ title }}</div>
<div mat-dialog-content>
  @if (isLoadingResidences()) {
    <div class="loading-container">
      <mat-spinner diameter="40"></mat-spinner>
      <p>Cargando residencias...</p>
    </div>
  } @else {
    <form [formGroup]="managerForm" class="form_modal">
      <mat-form-field appearance="outline" class="full-width custom-field">
        <mat-label>Nombre Completo</mat-label>
        <input matInput formControlName="name" placeholder="Nombre completo del gestor" />
        @if (managerForm.get('name')?.hasError('required')) {
          <mat-error>El nombre es obligatorio</mat-error>
        }
      </mat-form-field>

      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Residencias Asignadas</mat-label>
        <mat-select formControlName="residences" multiple placeholder="Selecciona las residencias">
          @for (residence of residences(); track residence.id) {
            <mat-option [value]="residence.id">
              {{ residence.name }}
            </mat-option>
          }
          @if (residences().length === 0) {
            <mat-option disabled>No hay residencias disponibles</mat-option>
          }
        </mat-select>
        @if (managerForm.get('residences')?.hasError('required')) {
          <mat-error>Debe seleccionar al menos una residencia</mat-error>
        }
      </mat-form-field>

      <mat-form-field appearance="outline" class="full-width custom-field">
        <mat-label>Usuario</mat-label>
        <input matInput formControlName="alias" placeholder="Nombre de usuario para inicio de sesión" />
        @if (managerForm.get('alias')?.hasError('required')) {
          <mat-error>El alias es obligatorio</mat-error>
        }
      </mat-form-field>
      @if (!isEditMode()) {
        <mat-form-field appearance="outline" class="full-width custom-field">
          <mat-label>Contraseña</mat-label>
          <input matInput [type]="hidePassword() ? 'password' : 'text'" formControlName="password" placeholder="Contraseña" />
          <button mat-icon-button matSuffix (click)="togglePasswordVisibility()" type="button">
            <mat-icon>{{ hidePassword() ? 'visibility' : 'visibility_off' }}</mat-icon>
          </button>
          @if (managerForm.get('password')?.hasError('required')) {
            <mat-error>La contraseña es obligatoria</mat-error>
          }
        </mat-form-field>
      } @else {
        <mat-form-field appearance="outline" class="full-width custom-field">
          <mat-label>Nueva Contraseña (opcional)</mat-label>
          <input
            matInput
            [type]="hidePassword() ? 'password' : 'text'"
            formControlName="password"
            placeholder="Dejar en blanco para mantener la actual" />
          <button mat-icon-button matSuffix (click)="togglePasswordVisibility()" type="button">
            <mat-icon>{{ hidePassword() ? 'visibility' : 'visibility_off' }}</mat-icon>
          </button>
          @if (managerForm.get('password')?.hasError('minlength')) {
            <mat-error>La contraseña debe tener al menos 6 caracteres</mat-error>
          }
        </mat-form-field>
      }
    </form>
  }
</div>

<div mat-dialog-actions align="end">
  <button mat-button (click)="onCancel()" [disabled]="isLoading()">Cancelar</button>
  <button
    mat-raised-button
    color="primary"
    (click)="onSubmit()"
    [disabled]="isLoading() || managerForm.invalid || isLoadingResidences()">
    @if (!isLoading()) {
      <span>{{ isEditMode() ? 'Actualizar' : 'Crear' }}</span>
    }
    @if (isLoading()) {
      <span>Guardando...</span>
    }
  </button>
</div>
